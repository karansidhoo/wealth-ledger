<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Net Worth & Debt Tracker</title>
    
    <!-- App Icon for iOS/Android Home Screen -->
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOAAAADgCAYAAAAaLWrhAAAACXBIWXMAAAsTAAALEwEAmpwYAAAGB0lEQVR4nO3dTW4bRxCG4dagABG8yCqLnH2AvMAEucg+iFwnT5A3yDlGXiBvEGaVvYhXgQyQYCHJomvI6e6qfvh+QKGR7JHu6qef6q4eL4qiEAAAAE29bzsAAAA4R4IAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAwQoIAAMAICQIAACMkCAAADJAgAAAw4k9m36wH5+d7OAAAAABJRU5ErkJggg==">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4f46e5; /* Indigo 600 */
            --primary-light: #818cf8;
            --primary-dark: #4338ca;
            --accent: #10b981; /* Emerald 500 */
            --danger: #ef4444;
            --bg-body: #f3f4f6;
            --surface: #ffffff;
            --text-main: #111827;
            --text-muted: #6b7280;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* --- Modern Header --- */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            padding: 30px 40px;
            border-radius: 24px;
            margin-bottom: 40px;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .header-content { z-index: 2; }
        
        h1 {
            font-size: 2rem;
            font-weight: 800;
            letter-spacing: -0.025em;
            margin: 0 0 8px 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        p.subtitle {
            margin: 0;
            color: var(--text-muted);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Decorative SVG in Header */
        .header-graphic {
            position: absolute;
            right: -20px;
            top: -20px;
            opacity: 0.1;
            transform: rotate(-10deg) scale(1.5);
            pointer-events: none;
            color: var(--primary);
        }
        
        .header-icon-main {
            display: none;
        }
        @media(min-width: 768px) {
            .header-icon-main {
                display: block;
                color: var(--primary);
                font-size: 64px;
                opacity: 0.2;
                margin-right: 20px;
            }
        }

        /* --- Grid Layout --- */
        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 32px;
        }
        @media(min-width: 1024px) {
            .grid { grid-template-columns: 360px 1fr; }
        }

        /* --- Panels & Cards --- */
        .panel {
            background: var(--surface);
            padding: 24px;
            border-radius: 20px;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255,255,255,0.5);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .panel:hover {
            box-shadow: var(--shadow-lg);
        }

        .panel h2 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-top: 0;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-main);
        }

        .panel h2 i { color: var(--primary); }

        /* --- Form Elements --- */
        .form-group { margin-bottom: 20px; }
        
        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        input, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            color: var(--text-main);
            transition: all 0.2s;
            box-sizing: border-box;
            background: #f9fafb;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-light);
            background: white;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .chart-filter-select {
            width: auto;
            min-width: 220px;
        }
        @media (max-width: 600px) {
            .chart-filter-select {
                width: 100%;
            }
        }

        /* --- Buttons --- */
        button.btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px -1px rgba(79, 70, 229, 0.4);
        }
        .btn-primary:active { transform: translateY(0); }

        .btn-secondary {
            background: #fff;
            color: var(--text-main);
            border: 2px solid #e5e7eb;
        }
        .btn-secondary:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .btn-danger {
            background: white;
            color: var(--danger);
            border: 2px solid #fee2e2;
            width: 100%;
        }
        .btn-danger:hover {
            background: #fef2f2;
            border-color: var(--danger);
        }

        .btn-icon-delete {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        .btn-icon-delete:hover {
            background-color: #fef2f2;
            color: var(--danger);
        }

        /* --- Summary Layout Rows --- */
        .summary-row-top {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .summary-row-bottom {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 32px;
        }

        @media(min-width: 640px) {
            .summary-row-top { grid-template-columns: 1fr 1fr; }
            .summary-row-bottom { grid-template-columns: repeat(3, 1fr); }
        }

        .total-card {
            color: white;
            text-align: center;
            padding: 30px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 20px;
            box-shadow: var(--shadow-md);
        }

        .total-card.liability { background: linear-gradient(135deg, #111827 0%, #374151 100%); }
        .total-card.cc-debt { background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%); }
        .total-card.reduced { background: linear-gradient(135deg, #059669 0%, #047857 100%); }
        .total-card.assets { background: linear-gradient(135deg, #0891b2 0%, #155e75 100%); }
        .total-card.net-worth { background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); }

        .total-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle at top right, rgba(255,255,255,0.1) 0%, transparent 60%);
        }

        .total-label {
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 0.75rem;
            font-weight: 600;
            opacity: 0.8;
            margin-bottom: 8px;
            position: relative;
        }

        .total-amount {
            font-size: 2.2rem;
            font-weight: 800;
            line-height: 1;
            letter-spacing: -1px;
            position: relative;
            text-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* --- Priority List --- */
        .priority-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .priority-item {
            background: white;
            border: 1px solid #e5e7eb;
            padding: 20px;
            border-radius: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .priority-item.focus {
            border: 2px solid var(--danger);
            background: #fff5f5;
        }
        
        .priority-item.focus::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 6px;
            background: var(--danger);
        }

        .card-info h3 {
            margin: 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-info span {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 4px;
            display: block;
        }

        .priority-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .priority-badge {
            font-size: 0.75rem;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 99px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .badge-red { background: #fef2f2; color: var(--danger); border: 1px solid #fecaca; }
        .badge-gray { background: #f3f4f6; color: var(--text-muted); }

        /* --- Charts Grid --- */
        .charts-grid {
            display: grid;
            gap: 32px;
            margin-top: 32px;
        }
        @media(min-width: 768px) {
            .charts-grid { grid-template-columns: 1fr 1fr; }
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .full-width-chart {
            grid-column: 1 / -1;
            margin-top: 20px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* --- Settings Modal --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        
        .modal-content {
            background: white;
            width: 100%;
            max-width: 400px;
            border-radius: 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f9fafb;
        }
        .modal-header h3 { margin: 0; font-size: 1.1rem; }
        
        .modal-body {
            padding: 24px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-muted);
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-content">
            <h1>Net Worth & Debt Planner</h1>
            <p class="subtitle">
                <i class="ph-bold ph-trend-down"></i>
                Avalanche Method & Net Worth Tracker
            </p>
        </div>
        <i class="ph-duotone ph-wallet header-icon-main"></i>
        <svg class="header-graphic" width="300" height="300" viewBox="0 0 24 24" fill="currentColor">
            <path d="M21,18V19A2,2 0 0,1 19,21H5C3.89,21 3,20.1 3,19V5A2,2 0 0,1 5,3H19A2,2 0 0,1 21,5V6H12C10.89,6 10,6.9 10,8V16A2,2 0 0,0 12,18M12,16H22V8H12M16,13.5A1.5,1.5 0 0,1 14.5,12A1.5,1.5 0 0,1 16,10.5A1.5,1.5 0 0,1 17.5,12A1.5,1.5 0 0,1 16,13.5Z" />
        </svg>
    </header>

    <div class="grid">
        <!-- Sidebar -->
        <aside>
            <!-- 1. Add Card Form -->
            <div class="panel">
                <h2><i class="ph-duotone ph-credit-card"></i> Add Card</h2>
                <form id="addForm">
                    <div class="form-group">
                        <label>Card Name</label>
                        <input type="text" id="cardName" placeholder="e.g. Citibank Costco" required>
                    </div>
                    <div class="form-group">
                        <label>Interest Rate (APR %)</label>
                        <input type="number" id="cardApr" step="0.01" placeholder="24.99" required>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="ph-bold ph-plus"></i> Add Card
                    </button>
                </form>
            </div>

            <!-- 2. Add Liability Form -->
            <div class="panel" style="margin-top: 20px;">
                <h2><i class="ph-duotone ph-bank"></i> Add Liability</h2>
                <form id="addLiabilityForm">
                    <div class="form-group">
                        <label>Liability Name</label>
                        <input type="text" id="loanName" placeholder="e.g. Car Loan" required>
                    </div>
                    <div class="form-group">
                        <label>Interest Rate (APR %)</label>
                        <input type="number" id="loanApr" step="0.01" placeholder="4.5">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="ph-bold ph-plus"></i> Add Liability
                    </button>
                </form>
            </div>

            <!-- 3. Add Asset Form -->
            <div class="panel" style="margin-top: 20px;">
                <h2><i class="ph-duotone ph-coin-vertical"></i> Add Asset</h2>
                <form id="addAssetForm">
                    <div class="form-group">
                        <label>Asset Name</label>
                        <input type="text" id="assetName" placeholder="e.g. 401k, Home Value" required>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="ph-bold ph-plus"></i> Add Asset
                    </button>
                </form>
            </div>

            <!-- 4. Log Balance -->
            <div class="panel" style="margin-top: 32px;">
                <h2><i class="ph-duotone ph-notebook"></i> Log Balance</h2>
                <form id="balanceForm">
                    <div class="form-group">
                        <label>Select Item</label>
                        <select id="cardSelect" required></select>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="logDate" required>
                    </div>
                    <div class="form-group">
                        <label>Ending Balance / Value ($)</label>
                        <input type="number" id="balanceVal" step="0.01" required>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="ph-bold ph-floppy-disk"></i> Save Entry
                    </button>
                </form>
            </div>
            
            <!-- Settings Button -->
            <button onclick="openSettings()" class="btn btn-secondary" style="margin-top: 20px;">
                <i class="ph-bold ph-gear"></i> Settings
            </button>
        </aside>

        <!-- Main Content -->
        <main>
            <!-- Summary Row 1: Net Worth & Assets -->
            <div class="summary-row-top">
                <div class="panel total-card net-worth">
                    <div class="total-label">Total Net Worth</div>
                    <div class="total-amount" id="totalNetWorthDisplay">$0.00</div>
                </div>
                <div class="panel total-card assets">
                    <div class="total-label">Total Assets</div>
                    <div class="total-amount" id="totalAssetsDisplay">$0.00</div>
                </div>
            </div>

            <!-- Summary Row 2: Liabilities, CC, Reduced -->
            <div class="summary-row-bottom">
                <div class="panel total-card liability">
                    <div class="total-label">Total Liabilities</div>
                    <div class="total-amount" id="totalLiabilityDisplay">$0.00</div>
                </div>
                <div class="panel total-card cc-debt">
                    <div class="total-label">Credit Card Debt</div>
                    <div class="total-amount" id="totalCCDisplay">$0.00</div>
                </div>
                <div class="panel total-card reduced">
                    <div class="total-label">Debt Reduced</div>
                    <div class="total-amount" id="totalReducedDisplay">$0.00</div>
                </div>
            </div>

            <!-- Strategy -->
            <div class="panel">
                <h2><i class="ph-duotone ph-list-checks"></i> Priority Plan (Credit Cards)</h2>
                <div id="priorityList" class="priority-list">
                    <div style="text-align:center; padding: 40px; color: var(--text-muted);">
                        <i class="ph-duotone ph-cards" style="font-size: 48px; margin-bottom: 10px; display:block;"></i>
                        Add credit cards to see strategy.
                    </div>
                </div>
            </div>

            <!-- Liability List -->
            <div class="panel" style="margin-top: 32px;">
                <h2><i class="ph-duotone ph-bank"></i> Other Liabilities</h2>
                <div id="liabilityList" class="priority-list">
                    <div style="text-align:center; padding: 20px; color: var(--text-muted);">
                        No other liabilities added.
                    </div>
                </div>
            </div>

            <!-- Assets List -->
            <div class="panel" style="margin-top: 32px;">
                <h2><i class="ph-duotone ph-coin-vertical"></i> Assets</h2>
                <div id="assetList" class="priority-list">
                    <div style="text-align:center; padding: 20px; color: var(--text-muted);">
                        No assets added.
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <div class="panel">
                    <h2><i class="ph-duotone ph-chart-line-up"></i> CC Debt History</h2>
                    <div class="chart-container">
                        <canvas id="chartTotal"></canvas>
                    </div>
                </div>
                <div class="panel">
                    <h2><i class="ph-duotone ph-chart-pie-slice"></i> Card Breakdown</h2>
                    <div class="chart-container">
                        <canvas id="chartIndiv"></canvas>
                    </div>
                </div>
                
                <!-- Liability History (NOW FIRST) -->
                <div class="panel full-width-chart">
                    <div class="chart-header">
                        <h2 style="margin:0"><i class="ph-duotone ph-globe"></i> Liability History</h2>
                        <select id="liabilityFilter" onchange="renderCharts()" class="chart-filter-select">
                            <option value="all">Total All Debt</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="chartLiability"></canvas>
                    </div>
                </div>

                <!-- Net Worth & Assets (NOW SECOND) -->
                <div class="panel full-width-chart">
                    <div class="chart-header">
                        <h2 style="margin:0"><i class="ph-duotone ph-trend-up"></i> Net Worth & Assets</h2>
                        <select id="netWorthFilter" onchange="renderCharts()" class="chart-filter-select">
                            <option value="networth">Total Net Worth</option>
                            <option value="assets">Total Assets</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="chartNetWorth"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="ph-bold ph-gear"></i> Settings</h3>
            <button onclick="closeSettings()" class="close-modal"><i class="ph-bold ph-x"></i></button>
        </div>
        <div class="modal-body">
            <p style="color:var(--text-muted); margin-bottom:20px;">
                Manage your application data here. This action cannot be undone.
            </p>
            <button onclick="clearAll()" class="btn btn-danger">
                <i class="ph-bold ph-trash"></i> Reset All Data
            </button>
        </div>
    </div>
</div>

<script>
    // 1. STATE & STORAGE
    let data = {
        cards: JSON.parse(localStorage.getItem('tracker_cards')) || [],
        loans: JSON.parse(localStorage.getItem('tracker_loans')) || [],
        assets: JSON.parse(localStorage.getItem('tracker_assets')) || [],
        balances: JSON.parse(localStorage.getItem('tracker_balances')) || []
    };

    let chartTotalInstance = null;
    let chartIndivInstance = null;
    let chartLiabilityInstance = null;
    let chartNetWorthInstance = null;

    // 2. INITIALIZATION
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('logDate').valueAsDate = new Date();
        render();
    });

    // 3. CORE FUNCTIONS (Add/Delete/Log)
    function addCard(e) {
        e.preventDefault();
        const name = document.getElementById('cardName').value;
        const apr = parseFloat(document.getElementById('cardApr').value);
        const id = 'card_' + Date.now();
        data.cards.push({ id, name, apr });
        save();
        document.getElementById('addForm').reset();
        render();
    }

    function addLoan(e) {
        e.preventDefault();
        const name = document.getElementById('loanName').value;
        const aprVal = document.getElementById('loanApr').value;
        const apr = aprVal ? parseFloat(aprVal) : 0;
        const id = 'loan_' + Date.now();
        data.loans.push({ id, name, apr });
        save();
        document.getElementById('addLiabilityForm').reset();
        render();
    }

    function addAsset(e) {
        e.preventDefault();
        const name = document.getElementById('assetName').value;
        const id = 'asset_' + Date.now();
        data.assets.push({ id, name });
        save();
        document.getElementById('addAssetForm').reset();
        render();
    }

    function logBalance(e) {
        e.preventDefault();
        const itemId = document.getElementById('cardSelect').value;
        if (!itemId) return;
        const rawDate = document.getElementById('logDate').value;
        const month = rawDate.slice(0, 7);
        const amount = parseFloat(document.getElementById('balanceVal').value);
        const existing = data.balances.find(b => b.cardId === itemId && b.month === month);
        if(existing) {
            existing.amount = amount;
        } else {
            data.balances.push({ cardId: itemId, month, amount });
        }
        data.balances.sort((a,b) => a.month.localeCompare(b.month));
        save();
        document.getElementById('balanceVal').value = '';
        render();
    }
    
    function deleteItem(id) {
        if(confirm('Are you sure you want to delete this item and its history?')) {
            data.cards = data.cards.filter(c => c.id !== id);
            data.loans = data.loans.filter(l => l.id !== id);
            data.assets = data.assets.filter(a => a.id !== id);
            data.balances = data.balances.filter(b => b.cardId !== id);
            save();
            render();
        }
    }

    function save() {
        localStorage.setItem('tracker_cards', JSON.stringify(data.cards));
        localStorage.setItem('tracker_loans', JSON.stringify(data.loans));
        localStorage.setItem('tracker_assets', JSON.stringify(data.assets));
        localStorage.setItem('tracker_balances', JSON.stringify(data.balances));
    }

    // Modal Logic
    function openSettings() {
        document.getElementById('settingsModal').classList.add('active');
    }
    function closeSettings() {
        document.getElementById('settingsModal').classList.remove('active');
    }

    function clearAll() {
        if(confirm('Are you sure you want to delete ALL data?')) {
            localStorage.clear();
            data.cards = []; data.loans = []; data.assets = []; data.balances = [];
            closeSettings();
            render();
        }
    }

    function getLastBalance(id) {
        const bals = data.balances.filter(b => b.cardId === id);
        return bals.length > 0 ? bals[bals.length - 1].amount : 0;
    }

    // 4. RENDERING (Chart/View Logic)
    function render() {
        renderSelect();
        renderSummaries();
        renderPriority();
        renderLiabilityList();
        renderAssetList();
        renderCharts();
    }

    function renderSummaries() {
        let ccSum = 0; data.cards.forEach(c => ccSum += getLastBalance(c.id));
        let loanSum = 0; data.loans.forEach(l => loanSum += getLastBalance(l.id));
        let assetSum = 0; data.assets.forEach(a => assetSum += getLastBalance(a.id));

        const totalLiabilities = ccSum + loanSum;
        const netWorth = assetSum - totalLiabilities;
        
        // Calculate Starting Debt
        let startingDebt = 0;
        [...data.cards, ...data.loans].forEach(item => {
            const bals = data.balances.filter(b => b.cardId === item.id);
            if(bals.length > 0) startingDebt += bals[0].amount; 
        });
        const reducedAmount = startingDebt - totalLiabilities;

        document.getElementById('totalCCDisplay').textContent = '$' + ccSum.toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('totalLiabilityDisplay').textContent = '$' + totalLiabilities.toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('totalReducedDisplay').textContent = '$' + reducedAmount.toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('totalAssetsDisplay').textContent = '$' + assetSum.toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('totalNetWorthDisplay').textContent = '$' + netWorth.toLocaleString(undefined, {minimumFractionDigits: 2});
    }

    function renderSelect() {
        const sel = document.getElementById('cardSelect');
        const current = sel.value;
        sel.innerHTML = '<option value="">-- Select --</option>';
        
        const addGroup = (label, items) => {
            if(items.length){
                const grp = document.createElement('optgroup'); grp.label = label;
                items.forEach(i => {
                    const opt = document.createElement('option'); opt.value = i.id; opt.textContent = i.name;
                    grp.appendChild(opt);
                });
                sel.appendChild(grp);
            }
        };
        addGroup("Credit Cards", data.cards);
        addGroup("Other Liabilities", data.loans);
        addGroup("Assets", data.assets);
        sel.value = current;

        // Chart Filter
        const chartSel = document.getElementById('liabilityFilter');
        const chartCurrent = chartSel.value || 'all';
        chartSel.innerHTML = '<option value="all">Total All Debt</option>';
        data.loans.forEach(l => {
            const opt = document.createElement('option'); opt.value = l.id; opt.textContent = l.name; chartSel.appendChild(opt);
        });
        data.cards.forEach(c => {
            const opt = document.createElement('option'); opt.value = c.id; opt.textContent = c.name + " (Card)"; chartSel.appendChild(opt);
        });
        chartSel.value = chartCurrent;
    }

    function renderPriority() {
        const div = document.getElementById('priorityList');
        if(!data.cards.length) { div.innerHTML = `<div style="text-align:center; padding: 40px; color: var(--text-muted);"><i class="ph-duotone ph-cards" style="font-size: 48px; margin-bottom: 10px; display:block;"></i>Add credit cards to see strategy.</div>`; return; }

        const sorted = [...data.cards].sort((a,b) => b.apr - a.apr);
        let html = '';
        sorted.forEach((card, idx) => {
            const latest = getLastBalance(card.id);
            const isTarget = (idx === 0 && latest > 0);
            html += `<div class="priority-item ${isTarget ? 'focus' : ''}">
                <div class="card-info"><h3><i class="ph-fill ph-credit-card"></i> ${card.name}</h3><span>${card.apr}% APR &bull; $${latest.toLocaleString()} Balance</span></div>
                <div class="priority-right"><span class="priority-badge ${isTarget ? 'badge-red' : 'badge-gray'}">${isTarget ? '<i class="ph-bold ph-lightning"></i> PAY FIRST' : 'PAY MINIMUM'}</span><button onclick="deleteItem('${card.id}')" class="btn-icon-delete"><i class="ph-bold ph-trash"></i></button></div></div>`;
        });
        div.innerHTML = html;
    }

    function renderLiabilityList() {
        const div = document.getElementById('liabilityList');
        if(!data.loans.length) { div.innerHTML = `<div style="text-align:center; padding: 20px; color: var(--text-muted);">No other liabilities added.</div>`; return; }
        let html = '';
        data.loans.forEach(loan => {
            const latest = getLastBalance(loan.id);
            html += `<div class="priority-item"><div class="card-info"><h3><i class="ph-fill ph-bank"></i> ${loan.name}</h3><span>${loan.apr}% APR &bull; $${latest.toLocaleString()} Balance</span></div><button onclick="deleteItem('${loan.id}')" class="btn-icon-delete"><i class="ph-bold ph-trash"></i></button></div>`;
        });
        div.innerHTML = html;
    }

    function renderAssetList() {
        const div = document.getElementById('assetList');
        if(!data.assets.length) { div.innerHTML = `<div style="text-align:center; padding: 20px; color: var(--text-muted);">No assets added.</div>`; return; }
        let html = '';
        data.assets.forEach(asset => {
            const latest = getLastBalance(asset.id);
            html += `<div class="priority-item"><div class="card-info"><h3><i class="ph-fill ph-coin-vertical"></i> ${asset.name}</h3><span>Current Value: $${latest.toLocaleString()}</span></div><button onclick="deleteItem('${asset.id}')" class="btn-icon-delete"><i class="ph-bold ph-trash"></i></button></div>`;
        });
        div.innerHTML = html;
    }

    function renderCharts() {
        const months = [...new Set(data.balances.map(b => b.month))].sort();
        
        // Data Preps
        const ccTotalData = months.map(m => data.cards.reduce((acc, c) => acc + getBalanceForMonth(c.id, m), 0));
        
        // CC Individual
        const colors = ['#4f46e5', '#10b981', '#f59e0b', '#ec4899', '#8b5cf6'];
        const cardData = data.cards.map((card, i) => ({
            label: card.name, borderColor: colors[i % colors.length], backgroundColor: colors[i % colors.length], tension: 0.3, fill: false,
            data: months.map(m => getBalanceForMonth(card.id, m))
        }));

        // Liability Filter
        const filterId = document.getElementById('liabilityFilter').value;
        let liabilityData, liabilityLabel;
        if (filterId === 'all') {
            liabilityLabel = "Total Liability (All Debt)";
            liabilityData = months.map(m => {
                const cSum = data.cards.reduce((acc, c) => acc + getBalanceForMonth(c.id, m), 0);
                const lSum = data.loans.reduce((acc, l) => acc + getBalanceForMonth(l.id, m), 0);
                return cSum + lSum;
            });
        } else {
            const item = data.loans.find(l => l.id === filterId) || data.cards.find(c => c.id === filterId);
            liabilityLabel = item ? item.name : "Debt";
            liabilityData = months.map(m => getBalanceForMonth(filterId, m));
        }

        // Net Worth Chart
        const nwFilter = document.getElementById('netWorthFilter').value;
        let nwData, nwLabel, nwColor, nwBg;
        if(nwFilter === 'assets') {
            nwLabel = "Total Assets"; nwColor = '#0891b2';
            nwData = months.map(m => data.assets.reduce((acc, a) => acc + getBalanceForMonth(a.id, m), 0));
        } else {
            nwLabel = "Total Net Worth"; nwColor = '#7c3aed';
            nwData = months.map(m => {
                const aSum = data.assets.reduce((acc, a) => acc + getBalanceForMonth(a.id, m), 0);
                const cSum = data.cards.reduce((acc, c) => acc + getBalanceForMonth(c.id, m), 0);
                const lSum = data.loans.reduce((acc, l) => acc + getBalanceForMonth(l.id, m), 0);
                return aSum - (cSum + lSum);
            });
        }

        // --- Render ---
        if(chartTotalInstance) chartTotalInstance.destroy();
        chartTotalInstance = new Chart(document.getElementById('chartTotal'), {
            type: 'line', data: { labels: months, datasets: [{ label: 'Credit Card Debt', data: ccTotalData, borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false }
        });

        if(chartIndivInstance) chartIndivInstance.destroy();
        chartIndivInstance = new Chart(document.getElementById('chartIndiv'), {
            type: 'line', data: { labels: months, datasets: cardData }, options: { responsive: true, maintainAspectRatio: false }
        });

        if(chartNetWorthInstance) chartNetWorthInstance.destroy();
        chartNetWorthInstance = new Chart(document.getElementById('chartNetWorth'), {
            type: 'line', data: { labels: months, datasets: [{ label: nwLabel, data: nwData, borderColor: nwColor, backgroundColor: nwColor + '33', fill: true, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false }
        });

        if(chartLiabilityInstance) chartLiabilityInstance.destroy();
        chartLiabilityInstance = new Chart(document.getElementById('chartLiability'), {
            type: 'line', data: { labels: months, datasets: [{ label: liabilityLabel, data: liabilityData, borderColor: '#111827', backgroundColor: 'rgba(17, 24, 39, 0.1)', fill: true, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function getBalanceForMonth(id, month) {
        const entry = data.balances.find(b => b.cardId === id && b.month === month);
        if(entry) return entry.amount;
        const prev = data.balances.filter(b => b.cardId === id && b.month < month);
        return prev.length ? prev[prev.length-1].amount : 0;
    }

    // EVENTS
    document.getElementById('addForm').addEventListener('submit', addCard);
    document.getElementById('addLiabilityForm').addEventListener('submit', addLoan);
    document.getElementById('addAssetForm').addEventListener('submit', addAsset);
    document.getElementById('balanceForm').addEventListener('submit', logBalance);
</script>

</body>
</html>