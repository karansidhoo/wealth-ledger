<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wealth Ledger</title>
    
    <!-- Favicon for Browser Tabs -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='100' fill='%231e1b4b'/%3E%3Cpath d='M96 352l96-96 96 96 128-128' fill='none' stroke='%2310b981' stroke-width='48' stroke-linecap='round' stroke-linejoin='round'/%3E%3Ccircle cx='416' cy='224' r='32' fill='%2310b981'/%3E%3C/svg%3E">

    <!-- App Icon for iOS Home Screen -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='100' fill='%231e1b4b'/%3E%3Cpath d='M96 352l96-96 96 96 128-128' fill='none' stroke='%2310b981' stroke-width='48' stroke-linecap='round' stroke-linejoin='round'/%3E%3Ccircle cx='416' cy='224' r='32' fill='%2310b981'/%3E%3Ctext x='256' y='460' font-family='sans-serif' font-size='60' font-weight='bold' fill='%2364748b' text-anchor='middle'%3EWEALTH LEDGER%3C/text%3E%3C/svg%3E">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4f46e5; /* Indigo 600 */
            --primary-light: #818cf8;
            --primary-dark: #4338ca;
            --accent: #10b981; /* Emerald 500 */
            --danger: #ef4444;
            --bg-body: #f3f4f6;
            --surface: #ffffff;
            --text-main: #111827;
            --text-muted: #6b7280;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            /* Creative Background Graphic */
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(79, 70, 229, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(16, 185, 129, 0.08) 0%, transparent 40%);
            background-attachment: fixed;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px 16px;
        }

        /* --- Modern Header with Creative Background --- */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            /* Cleaner White Glassmorphism Base - Increased Opacity for Sticky Readability */
            background: rgba(255, 255, 255, 0.96);
            backdrop-filter: blur(12px);
            padding: 24px 30px;
            border-radius: 0 0 24px 24px; /* Rounded only at bottom when at top? No, keep all for aesthetic */
            border-radius: 24px;
            margin-bottom: 30px;
            box-shadow: 
                0 4px 6px -1px rgba(0, 0, 0, 0.05), 
                0 10px 15px -3px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255,255,255,0.8);
            border-top: 4px solid var(--primary); /* Accent Top Border */
            
            /* STICKY CONFIGURATION FIX */
            position: sticky;
            top: 0; /* Stick to very top edge */
            z-index: 999; /* Ensure it stays above charts/content */
            
            overflow: hidden;
            
            /* Professional Grid Pattern */
            background-image: 
                linear-gradient(rgba(79, 70, 229, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(79, 70, 229, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .header-content { z-index: 2; position: relative; }
        
        h1 {
            font-size: 1.75rem;
            font-weight: 800;
            letter-spacing: -0.03em;
            margin: 0 0 6px 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        p.subtitle {
            margin: 0;
            color: var(--text-muted);
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            z-index: 2;
            position: relative;
        }

        .settings-btn {
            background: white;
            border: 1px solid #e5e7eb;
            color: var(--text-main);
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }
        .settings-btn:hover { background: #f9fafb; transform: rotate(45deg); }

        /* --- Main Content Layout --- */
        .main-layout {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* --- Summary Cards Grid --- */
        .summary-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }
        @media(min-width: 600px) {
            .summary-row.top { grid-template-columns: 1fr 1fr; }
            .summary-row.bottom { grid-template-columns: repeat(3, 1fr); }
        }

        .total-card {
            color: white;
            text-align: left;
            padding: 24px 20px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-radius: 20px;
            box-shadow: var(--shadow-md);
            transition: transform 0.2s;
            min-height: 120px;
        }
        .total-card:hover { transform: translateY(-2px); }

        /* Gradient backgrounds */
        .total-card.net-worth { background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); }
        .total-card.assets { background: linear-gradient(135deg, #0891b2 0%, #155e75 100%); }
        .total-card.liability { background: linear-gradient(135deg, #111827 0%, #374151 100%); }
        .total-card.cc-debt { background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%); }
        .total-card.reduced { background: linear-gradient(135deg, #059669 0%, #047857 100%); }

        .total-card-icon {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 2.2rem;
            opacity: 0.2;
        }

        .total-label {
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.7rem;
            font-weight: 700;
            opacity: 0.9;
            margin-bottom: 4px;
            position: relative;
            z-index: 2;
        }

        .total-amount {
            font-size: 1.8rem;
            font-weight: 800;
            line-height: 1.1;
            letter-spacing: -0.5px;
            position: relative;
            z-index: 2;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 4px;
        }
        
        /* New Subtext Style */
        .total-subtext {
            font-size: 0.75rem;
            opacity: 0.85;
            font-weight: 500;
            position: relative;
            z-index: 2;
        }

        /* --- Sections --- */
        .section-container {
            background: rgba(255,255,255,0.7);
            border-radius: 24px;
            padding: 12px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.5);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 4px 8px;
        }
        .section-header h2 {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-action-btn {
            background: white;
            border: 1px solid #e5e7eb;
            padding: 8px 14px;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
        }
        .section-action-btn:hover { background: #f9fafb; transform: translateY(-1px); }

        /* --- Main Action Button (Moved Below Tiles) --- */
        .main-action-btn {
            width: 100%;
            background: var(--primary);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 16px;
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            box-shadow: 0 8px 20px -4px rgba(79, 70, 229, 0.4);
            margin-bottom: 10px;
            transition: transform 0.2s;
        }
        .main-action-btn:active { transform: scale(0.98); }

        /* --- Priority List --- */
        .priority-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .priority-item {
            background: white;
            border: 1px solid #e5e7eb;
            padding: 16px;
            border-radius: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            transition: transform 0.2s;
        }
        .priority-item:hover { transform: translateX(2px); }

        .priority-item.focus {
            border: 2px solid var(--danger);
            background: #fff5f5;
        }
        
        .card-info h3 {
            margin: 0;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-info span {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 4px;
            display: block;
        }

        .priority-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .priority-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 99px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: none; /* Hidden on very small screens, block on larger */
        }
        @media(min-width: 400px) { .priority-badge { display: block; } }

        .badge-red { background: #fef2f2; color: var(--danger); border: 1px solid #fecaca; }
        .badge-gray { background: #f3f4f6; color: var(--text-muted); }

        /* --- Charts Grid --- */
        .charts-grid {
            display: grid;
            gap: 24px;
            margin-top: 10px;
        }
        @media(min-width: 768px) {
            .charts-grid { grid-template-columns: 1fr 1fr; }
        }

        .panel {
            background: white;
            padding: 24px;
            border-radius: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid #e5e7eb;
        }
        .panel h2 { margin-top: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; color: var(--text-main); margin-bottom: 20px;}

        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }

        .full-width-chart {
            grid-column: 1 / -1;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        /* --- Modals --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        
        .modal-content {
            background: white;
            width: 100%;
            max-width: 450px;
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f9fafb;
        }
        .modal-header h3 { margin: 0; font-size: 1.1rem; }
        
        .modal-body { padding: 24px; }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            padding: 0;
            display: flex;
        }

        /* --- Form Elements in Modal --- */
        .form-group { margin-bottom: 20px; }
        label { display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-muted); margin-bottom: 8px; }
        
        /* Updated Input Styling for Uniformity */
        input, select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            color: var(--text-main);
            box-sizing: border-box;
            background: #f9fafb;
            /* Ensure Date and Selects look identical to Text inputs */
            appearance: none;
            -webkit-appearance: none;
            height: 52px; /* Fixed height for consistency */
            line-height: normal;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-light);
            background: white;
        }

        button.btn-primary {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-danger {
            background: #fee2e2;
            color: var(--danger);
            border: none;
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-icon-delete {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.2rem;
        }
        .btn-icon-delete:hover { color: var(--danger); }
        
        .chart-filter-select { padding: 0 12px; border-radius: 8px; border: 1px solid #d1d5db; height: 36px; font-size: 0.9rem; }

        /* New Header Decoration */
        .header-bg-decoration {
            position: absolute;
            top: -80px;
            right: -80px;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.25) 0%, rgba(99, 102, 241, 0) 70%);
            border-radius: 50%;
            filter: blur(40px);
            z-index: 0;
            pointer-events: none;
        }
        
        .header-bg-decoration-left {
            position: absolute;
            bottom: -60px;
            left: -60px;
            width: 250px;
            height: 250px;
            background: radial-gradient(circle, rgba(16, 185, 129, 0.2) 0%, rgba(16, 185, 129, 0) 70%);
            border-radius: 50%;
            filter: blur(40px);
            z-index: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div class="container">
    <!-- Header -->
    <header>
        <div class="header-bg-decoration"></div>
        <div class="header-bg-decoration-left"></div>
        <div class="header-content">
            <h1>Wealth Ledger</h1>
            <p class="subtitle"><i class="ph-bold ph-trend-down"></i> Net Worth & Debt Planner</p>
        </div>
        <div class="header-actions">
            <!-- Settings is here, Update moved to body -->
            <button onclick="openModal('settingsModal')" class="settings-btn" title="Settings">
                <i class="ph-bold ph-gear"></i>
            </button>
        </div>
    </header>

    <div class="main-layout">
        
        <!-- Summary Section -->
        <div class="summary-section">
            <div class="summary-row top" style="margin-bottom: 16px;">
                <div class="total-card net-worth">
                    <i class="ph-duotone ph-wallet total-card-icon"></i>
                    <div class="total-label">Net Worth</div>
                    <div class="total-amount" id="totalNetWorthDisplay">$0.00</div>
                    <div class="total-subtext">Assets - Liabilities</div>
                </div>
                <div class="total-card assets">
                    <i class="ph-duotone ph-coins total-card-icon"></i>
                    <div class="total-label">Total Assets</div>
                    <div class="total-amount" id="totalAssetsDisplay">$0.00</div>
                    <div class="total-subtext" id="assetCountSubtext">0 accounts</div>
                </div>
            </div>
            <div class="summary-row bottom">
                <div class="total-card liability">
                    <i class="ph-duotone ph-scales total-card-icon"></i>
                    <div class="total-label">Liabilities</div>
                    <div class="total-amount" id="totalLiabilityDisplay">$0.00</div>
                    <div class="total-subtext">All accounts combined</div>
                </div>
                <div class="total-card cc-debt">
                    <i class="ph-duotone ph-credit-card total-card-icon"></i>
                    <div class="total-label">CC Debt</div>
                    <div class="total-amount" id="totalCCDisplay">$0.00</div>
                    <div class="total-subtext" id="ccCountSubtext">0 active cards</div>
                </div>
                <div class="total-card reduced">
                    <i class="ph-duotone ph-trend-down total-card-icon"></i>
                    <div class="total-label">Reduced</div>
                    <div class="total-amount" id="totalReducedDisplay">$0.00</div>
                    <div class="total-subtext">Since tracking began</div>
                </div>
            </div>
        </div>

        <!-- Main Action Button (Moved Here) -->
        <button onclick="openLogBalance()" class="main-action-btn">
            <i class="ph-bold ph-pencil-simple"></i>
            Update Balances
        </button>

        <!-- Visual Analytics Title -->
        <div class="section-header" style="margin-top: 32px; margin-bottom: 16px;">
            <h2 style="font-size: 1.4rem; color: var(--primary-dark);"><i class="ph-duotone ph-chart-polar"></i> Visual Analytics</h2>
        </div>

        <!-- Charts Section (Reordered) -->
        <div class="charts-grid">
            
            <!-- Net Worth & Assets (MOVED TO TOP) -->
            <div class="panel full-width-chart">
                <div class="chart-header">
                    <h2><i class="ph-duotone ph-trend-up"></i> Net Worth & Assets</h2>
                    <select id="netWorthFilter" onchange="renderCharts()" class="chart-filter-select">
                        <option value="networth">Total Net Worth</option>
                        <option value="assets">Total Assets</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="chartNetWorth"></canvas>
                </div>
            </div>

            <!-- Liability History -->
            <div class="panel full-width-chart">
                <div class="chart-header">
                    <h2><i class="ph-duotone ph-globe"></i> Liability History</h2>
                    <select id="liabilityFilter" onchange="renderCharts()" class="chart-filter-select">
                        <option value="all">Total All Debt</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="chartLiability"></canvas>
                </div>
            </div>

            <!-- Total CC Debt (Renamed & Styled) -->
            <div class="panel">
                <h2><i class="ph-duotone ph-chart-line-up"></i> Total CC Debt</h2>
                <div class="chart-container">
                    <canvas id="chartTotal"></canvas>
                </div>
            </div>
            <div class="panel">
                <h2><i class="ph-duotone ph-chart-pie-slice"></i> Card Breakdown</h2>
                <div class="chart-container">
                    <canvas id="chartIndiv"></canvas>
                </div>
            </div>
        </div>

        <!-- Credit Cards Section -->
        <div class="section-container">
            <div class="section-header">
                <h2><i class="ph-duotone ph-credit-card"></i> Credit Cards</h2>
                <button onclick="openModal('addCardModal')" class="section-action-btn">
                    <i class="ph-bold ph-plus"></i> Add New
                </button>
            </div>
            <!-- Avalanche Method Subtext -->
            <p style="margin: -8px 0 16px 8px; font-size: 0.8rem; color: var(--text-muted); font-weight: 500;">
                <i class="ph-bold ph-lightning" style="color:var(--danger)"></i> Avalanche Method: Highest Rate First
            </p>
            <div id="priorityList" class="priority-list">
                <div style="text-align:center; padding: 20px; color: var(--text-muted); background: white; border-radius: 16px;">
                    No cards added.
                </div>
            </div>
        </div>

        <!-- Liabilities Section -->
        <div class="section-container">
            <div class="section-header">
                <h2><i class="ph-duotone ph-bank"></i> Other Liabilities</h2>
                <button onclick="openModal('addLiabilityModal')" class="section-action-btn">
                    <i class="ph-bold ph-plus"></i> Add New
                </button>
            </div>
            <div id="liabilityList" class="priority-list">
                <div style="text-align:center; padding: 20px; color: var(--text-muted); background: white; border-radius: 16px;">
                    No other liabilities.
                </div>
            </div>
        </div>

        <!-- Assets Section -->
        <div class="section-container">
            <div class="section-header">
                <h2><i class="ph-duotone ph-coin-vertical"></i> Assets</h2>
                <button onclick="openModal('addAssetModal')" class="section-action-btn">
                    <i class="ph-bold ph-plus"></i> Add New
                </button>
            </div>
            <div id="assetList" class="priority-list">
                <div style="text-align:center; padding: 20px; color: var(--text-muted); background: white; border-radius: 16px;">
                    No assets added.
                </div>
            </div>
        </div>

    </div>
</div>

<!-- =MODALS= -->

<!-- Add Card Modal -->
<div id="addCardModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Credit Card</h3>
            <button onclick="closeModal('addCardModal')" class="close-modal"><i class="ph-bold ph-x"></i></button>
        </div>
        <div class="modal-body">
            <form id="addCardForm">
                <div class="form-group">
                    <label>Card Name</label>
                    <input type="text" id="cardName" placeholder="e.g. Citibank Costco" required>
                </div>
                <div class="form-group">
                    <label>Interest Rate (APR %)</label>
                    <input type="number" id="cardApr" step="0.01" placeholder="24.99" required>
                </div>
                <button type="submit" class="btn-primary">Add Card</button>
            </form>
        </div>
    </div>
</div>

<!-- Add Liability Modal -->
<div id="addLiabilityModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Liability</h3>
            <button onclick="closeModal('addLiabilityModal')" class="close-modal"><i class="ph-bold ph-x"></i></button>
        </div>
        <div class="modal-body">
            <form id="addLiabilityForm">
                <div class="form-group">
                    <label>Liability Name</label>
                    <input type="text" id="loanName" placeholder="e.g. Car Loan" required>
                </div>
                <div class="form-group">
                    <label>Interest Rate (APR %)</label>
                    <input type="number" id="loanApr" step="0.01" placeholder="4.5">
                </div>
                <button type="submit" class="btn-primary">Add Liability</button>
            </form>
        </div>
    </div>
</div>

<!-- Add Asset Modal -->
<div id="addAssetModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Asset</h3>
            <button onclick="closeModal('addAssetModal')" class="close-modal"><i class="ph-bold ph-x"></i></button>
        </div>
        <div class="modal-body">
            <form id="addAssetForm">
                <div class="form-group">
                    <label>Asset Name</label>
                    <input type="text" id="assetName" placeholder="e.g. 401k, Home Value" required>
                </div>
                <button type="submit" class="btn-primary">Add Asset</button>
            </form>
        </div>
    </div>
</div>

<!-- Log Balance Modal -->
<div id="logBalanceModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Update Balance / Value</h3>
            <button onclick="closeModal('logBalanceModal')" class="close-modal"><i class="ph-bold ph-x"></i></button>
        </div>
        <div class="modal-body">
            <form id="balanceForm">
                <div class="form-group">
                    <label>Select Item</label>
                    <select id="cardSelect" required></select>
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="logDate" required>
                </div>
                <div class="form-group">
                    <label>New Amount ($)</label>
                    <input type="number" id="balanceVal" step="0.01" required>
                </div>
                <button type="submit" class="btn-primary">Save Entry</button>
            </form>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Settings</h3>
            <button onclick="closeModal('settingsModal')" class="close-modal"><i class="ph-bold ph-x"></i></button>
        </div>
        <div class="modal-body">
            <p style="color:var(--text-muted); margin-bottom:20px; font-size:0.9rem;">
                This will delete all your data permanently from this device.
            </p>
            <button onclick="clearAll()" class="btn-danger">
                <i class="ph-bold ph-trash"></i> Reset All Data
            </button>
        </div>
    </div>
</div>

<script>
    // 1. STATE & STORAGE
    let data = {
        cards: JSON.parse(localStorage.getItem('tracker_cards')) || [],
        loans: JSON.parse(localStorage.getItem('tracker_loans')) || [],
        assets: JSON.parse(localStorage.getItem('tracker_assets')) || [],
        balances: JSON.parse(localStorage.getItem('tracker_balances')) || []
    };

    let chartTotalInstance = null;
    let chartIndivInstance = null;
    let chartLiabilityInstance = null;
    let chartNetWorthInstance = null;

    // 2. INITIALIZATION
    document.addEventListener('DOMContentLoaded', () => {
        // Init Date for Log Modal
        document.getElementById('logDate').valueAsDate = new Date();
        render();
    });

    // 3. CORE FUNCTIONS (Add/Delete/Log)
    function addCard(e) {
        e.preventDefault();
        const name = document.getElementById('cardName').value;
        const apr = parseFloat(document.getElementById('cardApr').value);
        const id = 'card_' + Date.now();
        data.cards.push({ id, name, apr });
        save();
        document.getElementById('addCardForm').reset();
        closeModal('addCardModal');
        render();
    }

    function addLoan(e) {
        e.preventDefault();
        const name = document.getElementById('loanName').value;
        const aprVal = document.getElementById('loanApr').value;
        const apr = aprVal ? parseFloat(aprVal) : 0;
        const id = 'loan_' + Date.now();
        data.loans.push({ id, name, apr });
        save();
        document.getElementById('addLiabilityForm').reset();
        closeModal('addLiabilityModal');
        render();
    }

    function addAsset(e) {
        e.preventDefault();
        const name = document.getElementById('assetName').value;
        const id = 'asset_' + Date.now();
        data.assets.push({ id, name });
        save();
        document.getElementById('addAssetForm').reset();
        closeModal('addAssetModal');
        render();
    }

    function logBalance(e) {
        e.preventDefault();
        const itemId = document.getElementById('cardSelect').value;
        if (!itemId) return;
        const rawDate = document.getElementById('logDate').value;
        const month = rawDate.slice(0, 7);
        const amount = parseFloat(document.getElementById('balanceVal').value);
        const existing = data.balances.find(b => b.cardId === itemId && b.month === month);
        if(existing) {
            existing.amount = amount;
        } else {
            data.balances.push({ cardId: itemId, month, amount });
        }
        data.balances.sort((a,b) => a.month.localeCompare(b.month));
        save();
        document.getElementById('balanceVal').value = '';
        closeModal('logBalanceModal');
        render();
    }
    
    function deleteItem(id) {
        if(confirm('Delete this item and its history?')) {
            data.cards = data.cards.filter(c => c.id !== id);
            data.loans = data.loans.filter(l => l.id !== id);
            data.assets = data.assets.filter(a => a.id !== id);
            data.balances = data.balances.filter(b => b.cardId !== id);
            save();
            render();
        }
    }

    function save() {
        localStorage.setItem('tracker_cards', JSON.stringify(data.cards));
        localStorage.setItem('tracker_loans', JSON.stringify(data.loans));
        localStorage.setItem('tracker_assets', JSON.stringify(data.assets));
        localStorage.setItem('tracker_balances', JSON.stringify(data.balances));
    }

    // Modal Logic
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    
    function openLogBalance() {
        // Refresh select options before opening
        renderSelect();
        // Set date to today
        document.getElementById('logDate').valueAsDate = new Date();
        openModal('logBalanceModal');
    }

    function clearAll() {
        if(confirm('Delete ALL data?')) {
            localStorage.clear();
            data.cards = []; data.loans = []; data.assets = []; data.balances = [];
            closeModal('settingsModal');
            render();
        }
    }

    function getLastBalance(id) {
        const bals = data.balances.filter(b => b.cardId === id);
        return bals.length > 0 ? bals[bals.length - 1].amount : 0;
    }

    // 4. RENDERING (Chart/View Logic)
    function render() {
        renderSelect();
        renderSummaries();
        renderPriority();
        renderLiabilityList();
        renderAssetList();
        renderCharts();
    }

    function renderSummaries() {
        let ccSum = 0; data.cards.forEach(c => ccSum += getLastBalance(c.id));
        let loanSum = 0; data.loans.forEach(l => loanSum += getLastBalance(l.id));
        let assetSum = 0; data.assets.forEach(a => assetSum += getLastBalance(a.id));

        const totalLiabilities = ccSum + loanSum;
        const netWorth = assetSum - totalLiabilities;
        
        let startingDebt = 0;
        [...data.cards, ...data.loans].forEach(item => {
            const bals = data.balances.filter(b => b.cardId === item.id);
            if(bals.length > 0) startingDebt += bals[0].amount; 
        });
        const reducedAmount = startingDebt - totalLiabilities;

        document.getElementById('totalCCDisplay').textContent = '$' + ccSum.toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('totalLiabilityDisplay').textContent = '$' + totalLiabilities.toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('totalReducedDisplay').textContent = '$' + reducedAmount.toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('totalAssetsDisplay').textContent = '$' + assetSum.toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('totalNetWorthDisplay').textContent = '$' + netWorth.toLocaleString(undefined, {minimumFractionDigits: 2});

        // Update Subtext
        document.getElementById('ccCountSubtext').textContent = data.cards.length + " active cards";
        document.getElementById('assetCountSubtext').textContent = data.assets.length + " accounts";
    }

    function renderSelect() {
        const sel = document.getElementById('cardSelect');
        const current = sel.value;
        sel.innerHTML = '<option value="">-- Select Item --</option>';
        
        const addGroup = (label, items) => {
            if(items.length){
                const grp = document.createElement('optgroup'); grp.label = label;
                items.forEach(i => {
                    const opt = document.createElement('option'); opt.value = i.id; opt.textContent = i.name;
                    grp.appendChild(opt);
                });
                sel.appendChild(grp);
            }
        };
        addGroup("Credit Cards", data.cards);
        addGroup("Other Liabilities", data.loans);
        addGroup("Assets", data.assets);
        sel.value = current;

        // Chart Filter
        const chartSel = document.getElementById('liabilityFilter');
        const chartCurrent = chartSel.value || 'all';
        chartSel.innerHTML = '<option value="all">Total All Debt</option>';
        data.loans.forEach(l => {
            const opt = document.createElement('option'); opt.value = l.id; opt.textContent = l.name; chartSel.appendChild(opt);
        });
        data.cards.forEach(c => {
            const opt = document.createElement('option'); opt.value = c.id; opt.textContent = c.name + " (Card)"; chartSel.appendChild(opt);
        });
        chartSel.value = chartCurrent;
    }

    function renderPriority() {
        const div = document.getElementById('priorityList');
        if(!data.cards.length) { div.innerHTML = `<div style="text-align:center; padding: 20px; color: var(--text-muted); background:white; border-radius:16px;">No cards added.</div>`; return; }

        const sorted = [...data.cards].sort((a,b) => b.apr - a.apr);
        let html = '';
        sorted.forEach((card, idx) => {
            const latest = getLastBalance(card.id);
            const isTarget = (idx === 0 && latest > 0);
            html += `<div class="priority-item ${isTarget ? 'focus' : ''}">
                <div class="card-info"><h3><i class="ph-fill ph-credit-card"></i> ${card.name}</h3><span>${card.apr}% APR &bull; $${latest.toLocaleString()}</span></div>
                <div class="priority-right"><span class="priority-badge ${isTarget ? 'badge-red' : 'badge-gray'}">${isTarget ? '<i class="ph-bold ph-lightning"></i> PAY FIRST' : 'PAY MINIMUM'}</span><button onclick="deleteItem('${card.id}')" class="btn-icon-delete"><i class="ph-bold ph-trash"></i></button></div></div>`;
        });
        div.innerHTML = html;
    }

    function renderLiabilityList() {
        const div = document.getElementById('liabilityList');
        if(!data.loans.length) { div.innerHTML = `<div style="text-align:center; padding: 20px; color: var(--text-muted); background:white; border-radius:16px;">No other liabilities.</div>`; return; }
        let html = '';
        data.loans.forEach(loan => {
            const latest = getLastBalance(loan.id);
            html += `<div class="priority-item"><div class="card-info"><h3><i class="ph-fill ph-bank"></i> ${loan.name}</h3><span>${loan.apr}% APR &bull; $${latest.toLocaleString()}</span></div><button onclick="deleteItem('${loan.id}')" class="btn-icon-delete"><i class="ph-bold ph-trash"></i></button></div>`;
        });
        div.innerHTML = html;
    }

    function renderAssetList() {
        const div = document.getElementById('assetList');
        if(!data.assets.length) { div.innerHTML = `<div style="text-align:center; padding: 20px; color: var(--text-muted); background:white; border-radius:16px;">No assets added.</div>`; return; }
        let html = '';
        data.assets.forEach(asset => {
            const latest = getLastBalance(asset.id);
            html += `<div class="priority-item"><div class="card-info"><h3><i class="ph-fill ph-coin-vertical"></i> ${asset.name}</h3><span>Value: $${latest.toLocaleString()}</span></div><button onclick="deleteItem('${asset.id}')" class="btn-icon-delete"><i class="ph-bold ph-trash"></i></button></div>`;
        });
        div.innerHTML = html;
    }

    function renderCharts() {
        const months = [...new Set(data.balances.map(b => b.month))].sort();
        
        // Data Preps
        const ccTotalData = months.map(m => data.cards.reduce((acc, c) => acc + getBalanceForMonth(c.id, m), 0));
        
        // CC Individual
        const colors = ['#4f46e5', '#10b981', '#f59e0b', '#ec4899', '#8b5cf6'];
        const cardData = data.cards.map((card, i) => ({
            label: card.name, borderColor: colors[i % colors.length], backgroundColor: colors[i % colors.length], tension: 0.3, fill: false,
            data: months.map(m => getBalanceForMonth(card.id, m))
        }));

        // Liability Filter
        const filterId = document.getElementById('liabilityFilter').value;
        let liabilityData, liabilityLabel;
        if (filterId === 'all') {
            liabilityLabel = "Total Liability (All Debt)";
            liabilityData = months.map(m => {
                const cSum = data.cards.reduce((acc, c) => acc + getBalanceForMonth(c.id, m), 0);
                const lSum = data.loans.reduce((acc, l) => acc + getBalanceForMonth(l.id, m), 0);
                return cSum + lSum;
            });
        } else {
            const item = data.loans.find(l => l.id === filterId) || data.cards.find(c => c.id === filterId);
            liabilityLabel = item ? item.name : "Debt";
            liabilityData = months.map(m => getBalanceForMonth(filterId, m));
        }

        // Net Worth Chart
        const nwFilter = document.getElementById('netWorthFilter').value;
        let nwData, nwLabel, nwColor;
        if(nwFilter === 'assets') {
            nwLabel = "Total Assets"; nwColor = '#0891b2';
            nwData = months.map(m => data.assets.reduce((acc, a) => acc + getBalanceForMonth(a.id, m), 0));
        } else {
            nwLabel = "Total Net Worth"; nwColor = '#7c3aed';
            nwData = months.map(m => {
                const aSum = data.assets.reduce((acc, a) => acc + getBalanceForMonth(a.id, m), 0);
                const cSum = data.cards.reduce((acc, c) => acc + getBalanceForMonth(c.id, m), 0);
                const lSum = data.loans.reduce((acc, l) => acc + getBalanceForMonth(l.id, m), 0);
                return aSum - (cSum + lSum);
            });
        }

        // --- Render ---
        const ctxTotal = document.getElementById('chartTotal').getContext('2d');
        const gradientTotal = ctxTotal.createLinearGradient(0, 0, 0, 300);
        gradientTotal.addColorStop(0, 'rgba(79, 70, 229, 0.4)');
        gradientTotal.addColorStop(1, 'rgba(79, 70, 229, 0.0)');

        if(chartTotalInstance) chartTotalInstance.destroy();
        chartTotalInstance = new Chart(ctxTotal, {
            type: 'line', 
            data: { 
                labels: months, 
                datasets: [{ 
                    label: 'Total CC Debt', 
                    data: ccTotalData, 
                    borderColor: '#4f46e5', 
                    backgroundColor: gradientTotal, // Shaded area gradient
                    fill: true, // Enable shaded area
                    tension: 0.3 
                }] 
            }, 
            options: { responsive: true, maintainAspectRatio: false }
        });

        if(chartIndivInstance) chartIndivInstance.destroy();
        chartIndivInstance = new Chart(document.getElementById('chartIndiv'), {
            type: 'line', data: { labels: months, datasets: cardData }, options: { responsive: true, maintainAspectRatio: false }
        });

        if(chartNetWorthInstance) chartNetWorthInstance.destroy();
        chartNetWorthInstance = new Chart(document.getElementById('chartNetWorth'), {
            type: 'line', data: { labels: months, datasets: [{ label: nwLabel, data: nwData, borderColor: nwColor, backgroundColor: nwColor + '33', fill: true, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false }
        });

        if(chartLiabilityInstance) chartLiabilityInstance.destroy();
        chartLiabilityInstance = new Chart(document.getElementById('chartLiability'), {
            type: 'line', data: { labels: months, datasets: [{ label: liabilityLabel, data: liabilityData, borderColor: '#111827', backgroundColor: 'rgba(17, 24, 39, 0.1)', fill: true, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function getBalanceForMonth(id, month) {
        const entry = data.balances.find(b => b.cardId === id && b.month === month);
        if(entry) return entry.amount;
        const prev = data.balances.filter(b => b.cardId === id && b.month < month);
        return prev.length ? prev[prev.length-1].amount : 0;
    }

    // EVENTS
    document.getElementById('addCardForm').addEventListener('submit', addCard);
    document.getElementById('addLiabilityForm').addEventListener('submit', addLoan);
    document.getElementById('addAssetForm').addEventListener('submit', addAsset);
    document.getElementById('balanceForm').addEventListener('submit', logBalance);
</script>

</body>
</html>
